<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>What&rsquo;s Brisbane Reading?</title>
    <meta name="description"
          content="Books that Brisbane is reading, based on library and book club data from the Brisbane Datastore">
    <meta name="author" content="Haikal Saadh">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .book .info {
            /* height: 700px;*/
        }

        .book .thumbnail {
            height: 200px;
            overflow: hidden;

        }

        .book .info h4 {

            margin-bottom: 10px;
            border-bottom: 1px solid #F5F5F5;
        }


    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet"/>

    <!-- Le fav and touch icons --> <!-- TODO
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

</head>


<body>
<!--
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>
            <a class="brand" href="#">Project name</a>

            <div class="nav-collapse">
                <ul class="nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
            <! - -/.nav-collapse - - >
        </div>
    </div>
</div>
-->
<div class="container">

    <!-- Main hero unit for a primary marketing message or call to action -->
    <div class="hero-unit">
        <h1>What&rsquo;s Brisbane Reading?</h1>

        <p>A look at what Brisbane is reading, based on data from the <a
                href="http://data.brisbane.qld.gov.au/index.php/datasets/">Brisbane Datastore</a>.</p>

    </div>

    <!-- Example row of columns -->
    <div class="row">
        <div id="bookList"></div>
    </div>

    <hr>

    <footer>
        <p>Built with Bootstrap, jQuery, Google Books API, and Data from the data.gov.au beta. This is still a work in progress...</p>
    </footer>

</div>
<!-- /container -->

<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js"></script>
<script src="js/uritemplates/jquery-uritemplate.1.0.min.js"></script>
<!--
<script src="js/bootstrap-transition.js"></script>
<script src="js/bootstrap-alert.js"></script>
<script src="js/bootstrap-modal.js"></script>
<script src="js/bootstrap-dropdown.js"></script>
<script src="js/bootstrap-scrollspy.js"></script>
<script src="js/bootstrap-tab.js"></script>
<script src="js/bootstrap-tooltip.js"></script>
<script src="js/bootstrap-popover.js"></script>
<script src="js/bootstrap-button.js"></script>
<script src="js/bootstrap-collapse.js"></script>
<script src="js/bootstrap-carousel.js"></script>
<script src="js/bootstrap-typeahead.js"></script>
-->
<script>
    $(document).ready(function () {
        var request = $.ajax({
            url: 'http://opendata.linkdigital.com.au/api/action/datastore_search_sql?sql=SELECT%20*%20FROM%20%2299bee72f-4a19-44f0-946b-2adc56ef199e%22%20WHERE%20%22Week%20Ending%22%20=%20(SELECT%20%20MAX(%22Week%20Ending%22)%20FROM%20%2299bee72f-4a19-44f0-946b-2adc56ef199e%22)'

        });

        request.done(function (data) {
            console.log(data.result.records);
            var books = data.result.records;
            $(books).each(function (i, book) {


                var bookContainer = $('<div></div>', {
                    "class": 'span3 book'
                }).appendTo('#bookList');

                var infoContainer = $("<div></div>", {
                    class: "info"
                }).appendTo(bookContainer);

                var title = book["Book Title"];
                var author = book["Book Author"]
                var imageLink = "" //TODO: Not found
                var blurb = "Not found"
                var googleBooksUrl = ""


                var googleBookLookup = $.ajax({
                    url: 'https://www.googleapis.com/books/v1/volumes?q=inauthor:{author} intitle:{title}&fields=items(volumeInfo(description,imageLinks,canonicalVolumeLink))&maxResults=1',
                    tokens: { author: author, title: title}

                });

                googleBookLookup.done(function (bookData) {
                    console.log(bookData);
                    //TODO: Check if there is a result first...
                    imageLink = bookData.items[0].volumeInfo.imageLinks.thumbnail;
                    blurb = bookData.items[0].volumeInfo.description;
                    googleBooksUrl = bookData.items[0].volumeInfo.canonicalVolumeLink


                    infoContainer.append(
                            $("<h3></h3>", { text: title }),
                            $("<h4></h4>", {text: author}),

                            $("<p></p>", {html: $("<img>", {src: imageLink})}),
                            $("<p></p>", {class: "blurb", html: blurb})
                    )

                    infoContainer.after(
                            $("<p></p>", {class: "btn-group" }
                            ).append(
                                            $("<a></a>", {class: "btn", "text": "eLibCat", href: book["eLibcat Link"] }),
                                            $("<a></a>", {class: "btn", "text": "Google Books", href: googleBooksUrl })
                                    )
                    );

                });


            }); // each()

        });


    });
</script>

</body>
</html>
